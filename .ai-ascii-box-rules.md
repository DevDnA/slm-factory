# [AI DIRECTIVE] ASCII 박스 다이어그램 작성 규칙

> **MANDATORY.** 이 파일은 AI 어시스턴트가 ASCII 박스 다이어그램을 작성·수정할 때
> **반드시** 따라야 하는 강제 규칙입니다.
>
> - 적용 범위: 프로젝트 내 모든 `.md`, `.txt`, 코드 주석의 ASCII 다이어그램
> - 적용 언어: 한국어, 일본어, 중국어 등 CJK 문자를 포함하는 모든 다이어그램
> - 위반 시: 터미널, 에디터, GitHub, VS Code 등에서 **정렬이 깨집니다**
>
> **이 규칙은 특정 프로젝트에 종속되지 않습니다. 어디에서든 적용하십시오.**

---

## 1. 허용/금지 문자 (NON-NEGOTIABLE)

### 1.1 허용 문자

| 문자 | 유니코드 | 용도 | Display Width |
|------|----------|------|---------------|
| `┌` | U+250C | 좌상단 모서리 | 1 |
| `┐` | U+2510 | 우상단 모서리 | 1 |
| `└` | U+2514 | 좌하단 모서리 | 1 |
| `┘` | U+2518 | 우하단 모서리 | 1 |
| `─` | U+2500 | 가로선 | 1 |
| `┬` | U+252C | 하단 분기점 | 1 |
| `┴` | U+2534 | 상단 분기점 | 1 |
| `▼` | U+25BC | 하향 화살표 | 1 |
| `▲` | U+25B2 | 상향 화살표 | 1 |
| `───▶` | 조합 | 우향 흐름 화살표 | 4 |
| `◀───` | 조합 | 좌향 흐름 화살표 | 4 |
| `(공백)` | U+0020 | 내부 패딩·정렬용 | 1 |

### 1.2 금지 문자

| 문자 | 유니코드 | 금지 이유 |
|------|----------|-----------|
| `│` | U+2502 | **CJK 문자와 함께 사용 시 정렬 파괴.** 터미널/에디터마다 이 문자를 1칸 또는 2칸으로 처리하는 기준이 다릅니다. CJK(2칸) 문자와 `│`(1~2칸 불확정)가 같은 열에 오면 열 정렬이 불가능해집니다. |
| `║` | U+2551 | 이중 세로선. `│`와 동일한 문제. |
| `\|` | U+007C | ASCII 파이프. Markdown 표(table) 문법 내에서만 허용. 다이어그램에서는 금지. |
| `╎` `┆` `┊` | U+254E 등 | 점선 세로선 계열. 동일한 폭 불확정 문제. |

> **원칙: 세로 방향의 선(line) 문자를 전부 금지합니다.**
> 박스의 좌우 벽은 세로선 없이 **공백 indent**로 표현합니다.

---

## 2. 박스 구조 규칙

### 2.1 기본 형태

박스는 **상단 테두리 + 텍스트 행(1줄 이상) + 하단 테두리**로 구성됩니다.
좌우 세로선은 그리지 않습니다.

```
┌──────────────────┐       ← 상단 테두리 (텍스트 없음)
  제목 텍스트                ← 텍스트 행 (indent ≥ 2)
  부가 설명                  ← 텍스트 행 (indent ≥ 2)
└──────────────────┘       ← 하단 테두리 (텍스트 없음)
```

구성 요소:
- 상단: `┌` + `─` × N + `┐`
- 하단: `└` + `─` × N + `┘` (분기 시: `└───┬───┘`)
- 좌우: **세로선 없음** — 텍스트는 공백(indent)으로 박스 안에 배치

### 2.2 텍스트 배치 (CRITICAL — 가장 많이 위반되는 규칙)

**규칙 A — 텍스트는 반드시 박스 안에 존재해야 합니다.**

| 조건 | 기준 | 필수 |
|------|------|------|
| 텍스트 시작 위치 | `┌`의 display column + 2 이상 | **MUST** |
| 텍스트 종료 위치 | `┐`의 display column - 1 이하 | **MUST** |

**규칙 B — 텍스트는 테두리 라인과 겹치면 안 됩니다.**

| 조건 | 설명 | 필수 |
|------|------|------|
| 행 분리 | 테두리 행(`┌──┐`, `└──┘`)과 텍스트 행은 별도 줄 | **MUST** |
| 열 분리 | 텍스트가 `┌` 또는 `┐`와 같은 display column에 오면 안 됨 | **MUST** |

```
# ✗ FAIL — indent=0, 텍스트가 ┌ 위치에서 시작
┌──────────────────┐
텍스트가 경계에 겹침
└──────────────────┘

# ✗ FAIL — indent=1, 불충분
┌──────────────────┐
 텍스트 간격 부족
└──────────────────┘

# ✓ PASS — indent=2
┌──────────────────┐
  텍스트 올바른 위치
└──────────────────┘
```

### 2.3 다중 박스 가로 나열 시 주의 (가장 흔한 실수)

박스를 가로로 나열하면, **앞쪽 박스의 텍스트가 올바르더라도 뒤쪽 박스에서 겹침이 발생**합니다.
**모든 박스를 개별적으로 검증해야 합니다.** 첫 번째 박스만 확인하면 안 됩니다.

```
# ✗ FAIL — Box 1은 OK이지만 Box 3의 "항목 3"가 ┌ 위치와 겹침
┌──────────────────┐ ┌──────────────────┐ ┌──────────────────┐
  항목 1              항목 2             항목 3
└──────────────────┘ └──────────────────┘ └──────────────────┘

# ✓ PASS — 모든 박스에서 indent=2 유지
┌──────────────────┐ ┌──────────────────┐ ┌──────────────────┐
  항목 1               항목 2               항목 3
└──────────────────┘ └──────────────────┘ └──────────────────┘
```

> **WHY**: 텍스트 행의 공백 수가 부족하면, 뒤쪽 박스의 텍스트가 해당 박스의
> `┌` 위치(display column)와 겹치거나 앞으로 밀려납니다.
> 이 문제는 CJK 문자가 포함된 행에서 더욱 심각해집니다 (섹션 3 참조).

---

## 3. CJK Wide-Char 정렬 (MOST IMPORTANT)

> **이 섹션의 규칙을 무시하면, 한글·일본어·중국어가 포함된 다이어그램은 100% 깨집니다.**

### 3.1 근본 원인

모노스페이스 폰트에서 문자별 표시 폭(display width)이 다릅니다:

| 문자 종류 | 예시 | Display Width | East Asian Width |
|-----------|------|---------------|------------------|
| ASCII 영문·숫자 | `A`, `1`, `-` | **1칸** | Na (Narrow) |
| ASCII 공백 | `(space)` | **1칸** | Na |
| 박스 드로잉 문자 | `┌`, `─`, `┐` | **1칸** | A (Ambiguous, 대부분 1칸) |
| **한글** | `가`, `문`, `파` | **2칸** | **W (Wide)** |
| **일본어 (히라가나)** | `あ`, `い`, `う` | **2칸** | **W (Wide)** |
| **일본어 (가타카나)** | `ア`, `イ`, `ウ` | **2칸** | **W (Wide)** |
| **일본어/중국어 (한자)** | `漢`, `字` | **2칸** | **W (Wide)** |
| **중국어 (간체/번체)** | `你`, `好` | **2칸** | **W (Wide)** |
| 전각 기호 | `！`, `？`, `（` | **2칸** | **F (Fullwidth)** |

**핵심 문제:**

```
문자열 "Hello"   → 5 chars, 5 display cols  (일치)
문자열 "안녕하세요" → 5 chars, 10 display cols (불일치!)
```

따라서 CJK가 포함된 행은 **char 수가 아닌 display width 기준**으로 정렬해야 합니다.

### 3.2 정렬 원칙

> **MANDATORY: 정렬은 반드시 display column 기준으로 맞춰야 합니다.**

- char position(문자 인덱스)이 아닌 **화면에 보이는 열 위치**가 기준입니다.
- 같은 다이어그램에서 ASCII 행과 CJK 행의 **padding 공백 수가 다를 수 있습니다.**
  이것은 정상입니다. Display column만 일치하면 됩니다.

### 3.3 Display Width 계산법

**Python:**

```python
import unicodedata

def display_width(text: str) -> int:
    """문자열의 모노스페이스 표시 폭을 계산합니다."""
    width = 0
    for char in text:
        eaw = unicodedata.east_asian_width(char)
        width += 2 if eaw in ('W', 'F') else 1
    return width
```

**JavaScript / TypeScript:**

```javascript
function displayWidth(text) {
  let width = 0;
  for (const char of text) {
    const code = char.codePointAt(0);
    // CJK Unified Ideographs, Hangul, Hiragana, Katakana, Fullwidth
    if ((code >= 0x1100 && code <= 0x115F) ||  // Hangul Jamo
        (code >= 0x2E80 && code <= 0x9FFF) ||  // CJK
        (code >= 0xAC00 && code <= 0xD7AF) ||  // Hangul Syllables
        (code >= 0xF900 && code <= 0xFAFF) ||  // CJK Compatibility
        (code >= 0xFE10 && code <= 0xFE6F) ||  // CJK Forms
        (code >= 0xFF01 && code <= 0xFF60) ||  // Fullwidth Forms
        (code >= 0x30000 && code <= 0x3134F)) { // CJK Extension G
      width += 2;
    } else {
      width += 1;
    }
  }
  return width;
}
```

### 3.4 정렬 알고리즘

박스 시작 display column 목록과 텍스트 목록이 주어졌을 때, 올바르게 정렬된 행을 생성하는 알고리즘:

```python
def build_aligned_line(box_starts: list[int], texts: list[str], indent: int = 2) -> str:
    """
    박스 시작 display column 목록과 텍스트 목록으로 정렬된 행을 생성합니다.

    Args:
        box_starts: 각 박스의 ┌ display column 위치 리스트 (예: [0, 22, 44])
        texts:      각 박스에 들어갈 텍스트 리스트  (예: ["Score", "Augment", "Analyze"])
        indent:     ┌ 위치로부터의 최소 들여쓰기     (기본 2)

    Returns:
        display column 기준으로 올바르게 정렬된 문자열
    """
    line = ""
    current_dcol = 0
    for box_start, text in zip(box_starts, texts):
        target_dcol = box_start + indent
        spaces_needed = target_dcol - current_dcol
        line += " " * spaces_needed
        line += text
        current_dcol = target_dcol + display_width(text)
    return line
```

### 3.5 CJK 정렬 예시 (Before → After)

3개 박스 (display column 시작: 0, 22, 44):

```
# ✗ FAIL — char position 기준으로 패딩했기 때문에 CJK 행의 뒤쪽 박스가 밀림
┌──────────────┐      ┌──────────────┐      ┌──────────────┐
  Score                 Augment               Analyze          ← ASCII: OK
  품질 평가              데이터 증강            통계 분석        ← CJK: Box 2,3 겹침!
└──────────────┘      └──────────────┘      └──────────────┘

# ✓ PASS — display width 기준으로 패딩, CJK 행에서 공백 수가 줄어듦 (정상)
┌──────────────┐      ┌──────────────┐      ┌──────────────┐
  Score                 Augment               Analyze          ← ASCII: 공백 17개
  품질 평가             데이터 증강           통계 분석        ← CJK:  공백 13개 (정상!)
└──────────────┘      └──────────────┘      └──────────────┘
```

> **ASCII 행과 CJK 행의 공백 수가 다른 것은 정상입니다.**
> CJK 문자가 2칸을 차지하므로 같은 display column에 도달하기 위해 더 적은 공백이 필요합니다.

---

## 4. 단어 표기 규칙

### 4.1 하이픈 쪼갬 금지

단어·모듈명·클래스명을 하이픈(`-`)으로 나누어 여러 줄에 걸치면 안 됩니다.

```
# ✗ FAIL
┌────────┐
  Gene-
  rate
└────────┘

# ✓ PASS — 박스를 넓힘
┌──────────────┐
  Generate
└──────────────┘
```

### 4.2 파일명 줄 바꿈 금지

파일명(경로 포함)을 여러 줄로 나누면 안 됩니다.

```
# ✗ FAIL
user_report_
final.json

# ✓ PASS
user_report_final.json
```

### 4.3 박스 폭이 부족할 때

텍스트가 박스 폭을 초과하면 **박스 폭을 늘려서** 텍스트를 수용합니다.
같은 행의 다른 박스도 함께 조정하여 정렬을 유지합니다.

```
# ✗ FAIL — 텍스트를 줄여서 박스에 맞춤
┌────────┐
  qa_s..
└────────┘

# ✓ PASS — 박스를 텍스트에 맞춤
┌──────────────────────┐
  qa_scored.json
└──────────────────────┘
```

---

## 5. 레이아웃 패턴

### 5.1 단일 박스 (중앙 배치)

```
                     ┌─────────────────────────────┐
                       제목 텍스트
                       부가 설명
                     └──────────────┬──────────────┘
                                    ▼
```

### 5.2 가로 나열 (그리드)

박스 사이 gap은 1칸(밀집) 또는 6칸(화살표 공간 확보) 등 용도에 따라 선택합니다.
**같은 다이어그램 내에서 gap을 통일합니다.**

```
# gap=1 (밀집형 — 구조도, 아키텍처 다이어그램)
┌──────────────────┐ ┌──────────────────┐ ┌──────────────────┐
  항목 1               항목 2               항목 3
└────────┬─────────┘ └────────┬─────────┘ └────────┬─────────┘

# gap=6 (여유형 — 흐름도, 파이프라인 다이어그램)
┌──────────────┐      ┌──────────────┐      ┌──────────────┐
  항목 1         ───▶    항목 2         ───▶    항목 3
└──────────────┘      └──────────────┘      └──────────────┘
```

### 5.3 세로 흐름 표시

```
└────────┬─────────┘
         ▼              ← ▼는 ┬와 동일한 display column에 위치
  출력 결과
```

### 5.4 다중 행 그리드

```
┌────────────┐ ┌────────────┐ ┌────────────┐
  1단계          2단계          3단계
└─────┬──────┘ └─────┬──────┘ └─────┬──────┘
      ▼              ▼              ▼
  출력 A          출력 B          출력 C

┌────────────┐ ┌────────────┐ ┌────────────┐
  4단계          5단계          6단계
└─────┬──────┘ └─────┬──────┘ └─────┬──────┘
      ▼              ▼              ▼
  출력 D          출력 E          출력 F
```

---

## 6. 검증 절차 (MANDATORY)

다이어그램을 작성하거나 수정한 후 **반드시** 다음을 검증하십시오.

### 6.1 체크리스트

| # | 검증 항목 | 필수 |
|---|----------|------|
| 1 | `│` (U+2502) 및 모든 세로선 문자가 사용되지 않았는가? | **MUST** |
| 2 | **모든** 박스(첫 번째뿐 아니라 마지막까지)의 텍스트가 `┌` display column + 2 이상에서 시작하는가? | **MUST** |
| 3 | **모든** 박스의 텍스트가 `┐` display column을 넘지 않는가? | **MUST** |
| 4 | 테두리 행(`┌──┐`, `└──┘`)과 텍스트 행이 별도 줄인가? | **MUST** |
| 5 | CJK 문자가 포함된 행의 간격이 **display width 기준**으로 계산되었는가? | **MUST** |
| 6 | 단어·파일명이 하이픈 쪼갬이나 줄 바꿈 없이 한 줄에 표기되었는가? | **MUST** |
| 7 | 같은 그리드 행의 모든 박스에서 동일한 indent가 적용되었는가? | **MUST** |
| 8 | `▼` 화살표가 해당 `┬`와 같은 display column에 위치하는가? | SHOULD |

### 6.2 검증 스크립트

다이어그램 수정 후 아래 스크립트로 자동 검증할 것을 **강력히 권장**합니다.

```python
import unicodedata
import sys


def display_width(s: str) -> int:
    """문자열의 모노스페이스 표시 폭을 계산합니다."""
    w = 0
    for c in s:
        eaw = unicodedata.east_asian_width(c)
        w += 2 if eaw in ('W', 'F') else 1
    return w


def find_boxes(border_line: str) -> list[tuple[int, int]]:
    """테두리 행에서 박스 경계 (┌ display col, ┐ display col)를 추출합니다."""
    boxes = []
    i = 0
    while i < len(border_line):
        if border_line[i] == '┌':
            start = i
            j = i + 1
            while j < len(border_line) and border_line[j] != '┐':
                j += 1
            boxes.append((start, j))
            i = j + 1
        else:
            i += 1
    return boxes


def check_forbidden_chars(line: str, line_num: int) -> list[str]:
    """금지된 세로선 문자가 포함되었는지 검사합니다."""
    forbidden = {'│', '║', '╎', '┆', '┊', '╏', '┃', '┇', '┋'}
    errors = []
    for ci, c in enumerate(line):
        if c in forbidden:
            errors.append(
                f"  Line {line_num}: 금지 문자 '{c}' (U+{ord(c):04X}) at char pos {ci}"
            )
    return errors


def verify_alignment(
    border_line: str,
    text_line: str,
    text_line_num: int,
    min_indent: int = 2,
) -> list[str]:
    """박스 테두리 행과 텍스트 행의 정렬을 검증합니다."""
    boxes = find_boxes(border_line)
    if not boxes:
        return []

    # 텍스트의 각 문자에 대해 display column 매핑
    dcol = 0
    char_dcols = []
    for c in text_line:
        char_dcols.append(dcol)
        eaw = unicodedata.east_asian_width(c)
        dcol += 2 if eaw in ('W', 'F') else 1

    errors = []
    for bi, (bstart, bend) in enumerate(boxes):
        for ci, c in enumerate(text_line):
            if c != ' ' and ci < len(char_dcols):
                dc = char_dcols[ci]
                if bstart <= dc <= bend:
                    indent = dc - bstart
                    if indent < min_indent:
                        errors.append(
                            f"  Line {text_line_num}, Box {bi+1}: "
                            f"indent={indent} < {min_indent} "
                            f"(display col {dc}, box starts at {bstart})"
                        )
                    break

    return errors


def verify_file(filepath: str, min_indent: int = 2) -> bool:
    """파일 내 모든 코드 블록의 다이어그램을 검증합니다."""
    with open(filepath, 'r', encoding='utf-8') as f:
        lines = f.readlines()

    in_code_block = False
    all_errors = []

    for i, line in enumerate(lines):
        raw = line.rstrip('\n')

        if raw.strip().startswith('```'):
            in_code_block = not in_code_block
            continue

        if not in_code_block:
            continue

        # 금지 문자 검사
        all_errors.extend(check_forbidden_chars(raw, i + 1))

        # 테두리 행 발견 시 다음 텍스트 행들 검증
        if '┌' in raw and '┐' in raw:
            for j in range(i + 1, len(lines)):
                text_raw = lines[j].rstrip('\n')
                if '└' in text_raw or '┌' in text_raw or text_raw.strip().startswith('```'):
                    break
                if text_raw.strip():
                    all_errors.extend(
                        verify_alignment(raw, text_raw, j + 1, min_indent)
                    )

    if all_errors:
        print(f"FAIL: {filepath}")
        for err in all_errors:
            print(err)
        return False
    else:
        print(f"PASS: {filepath}")
        return True


if __name__ == '__main__':
    files = sys.argv[1:] or ['README.md']
    results = [verify_file(f) for f in files]
    sys.exit(0 if all(results) else 1)
```

**실행 방법:**

```bash
# 단일 파일
python verify_ascii_boxes.py README.md

# 복수 파일
python verify_ascii_boxes.py README.md docs/design.md

# 프로젝트 전체 Markdown
find . -name '*.md' -exec python verify_ascii_boxes.py {} +
```

---

## 7. 흔한 실수와 해결법

### 7.1 "앞 박스는 맞는데 뒤 박스가 틀림"

**원인**: 텍스트 행에서 앞쪽 텍스트 이후의 공백 수를 대충 맞춤.

**해결**: 각 박스의 `┌` display column을 기준으로 indent를 개별 검증.

```python
for box_index, (box_start, box_end) in enumerate(boxes):
    text_dcol = get_first_nonspace_display_col(text_line, box_start, box_end)
    assert text_dcol >= box_start + 2, f"Box {box_index + 1} 겹침"
```

### 7.2 "ASCII 행은 맞는데 한글 행이 틀림"

**원인**: 한글 문자의 display width(2칸)를 고려하지 않고 char count로 패딩.

**해결**: `build_aligned_line()` 함수 사용 (섹션 3.4).

### 7.3 "에디터에서는 맞는데 터미널에서 깨짐"

**원인**: 에디터의 폰트가 모노스페이스가 아니거나, CJK width 처리가 다름.

**해결**: Unicode East Asian Width 표준(UAX #11) 기준으로 계산. 폰트에 의존하지 않음.

### 7.4 "박스 안 텍스트가 길어서 넘침"

**원인**: 박스 폭을 텍스트보다 작게 설정.

**해결**: 박스 폭 = max(텍스트 display width) + indent × 2. 텍스트를 줄이지 말고 박스를 넓힘.

---

## 8. 요약 (Quick Reference)

| # | 규칙 | 중요도 |
|---|------|--------|
| 1 | `│` 및 모든 세로선 문자 사용 금지 | **MUST** |
| 2 | 텍스트 indent ≥ 2 (display column 기준) | **MUST** |
| 3 | 텍스트가 `┌` `┐`과 같은 display column에 겹치지 않을 것 | **MUST** |
| 4 | CJK 행은 display width 기준으로 간격 계산 | **MUST** |
| 5 | 모든 박스 개별 검증 (첫 번째만 확인하면 안 됨) | **MUST** |
| 6 | 단어·파일명 한 줄 표기 (쪼갬 금지) | **MUST** |
| 7 | 테두리 행과 텍스트 행 분리 | **MUST** |
| 8 | 박스 폭 부족 시 박스를 넓힘 (텍스트를 줄이지 않음) | **MUST** |
| 9 | 같은 그리드 내 indent 통일 | SHOULD |
| 10 | 수정 후 검증 스크립트 실행 | SHOULD |
